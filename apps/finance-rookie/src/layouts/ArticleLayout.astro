---
import BaseLayout from "./BaseLayout.astro";
import BylineRow from "@theme/components/BylineRow.astro";
import WhyItMattersCompact from "@theme/components/WhyItMattersCompact.astro";
import RookieLens from "@theme/components/RookieLens.astro";
import { readingTime } from "@theme/utils/readingTime";
import { SITE_CONFIG } from "../site.config";
import ArticleBadges from "../components/ArticleBadges.astro";
import ArticleTOC from "../components/ArticleTOC.astro";
import RelatedArticles from "../components/RelatedArticles.astro";
import SupersededNotice from "../components/SupersededNotice.astro";
import { renderKw } from "../lib/kw";

const { article, headings = [], related = [], prev, next } = Astro.props;
const {
  title,
  excerpt,
  category,
  author_id,
  published_at,
  updated_at,
  hero_image,
  hero_alt,
  hero_caption,
  hero_source,
  takeaways,
  impact,
  do_now,
  rookie_lens,
  sources,
  methodology_note,
  superseded_by,
  superseded_by_url,
  updates
} = article.data;

const author = SITE_CONFIG.authors[author_id];
const categoryLabel = SITE_CONFIG.categories.find((item) => item.slug === category)?.label ?? category;
const getCategoryLabel = (slug) =>
  SITE_CONFIG.categories.find((item) => item.slug === slug)?.label ?? slug;
const heroImage = {
  src: hero_image ?? "/images/hero-finanza.svg",
  alt: hero_alt ?? title ?? `Immagine su ${categoryLabel}`,
  caption: hero_caption ?? "",
  sourceUrl: hero_source
};
const readTime = readingTime(article.body ?? "");
const displayDate = published_at ?? updated_at ?? new Date().toISOString();
const canonicalUrl = `${SITE_CONFIG.siteUrl}/article/${article.slug}`;
const articleVariant = category === "notizie" ? "news" : category === "analisi" ? "analysis" : "longform";
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "NewsArticle",
  headline: title,
  image: heroImage?.src ? [new URL(heroImage.src, SITE_CONFIG.siteUrl).toString()] : undefined,
  datePublished: displayDate,
  dateModified: updated_at ?? displayDate,
  author: [
    {
      "@type": "Person",
      name: author?.name ?? "Redazione · FinanceRookie",
      url: SITE_CONFIG.siteUrl
    }
  ],
  publisher: {
    "@type": "Organization",
    name: SITE_CONFIG.name,
    logo: {
      "@type": "ImageObject",
      url: new URL("/logo.svg", SITE_CONFIG.siteUrl).toString()
    }
  },
  description: excerpt,
  mainEntityOfPage: canonicalUrl
};
---
<BaseLayout title={title} description={excerpt} image={heroImage?.src} canonical={canonicalUrl} type="article">
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  </Fragment>
  <div class="reading-progress" id="reading-progress"></div>
  <article class={`container section-block article article--${articleVariant}`}>
    <div class="grid gap-12 lg:grid-cols-[2.2fr,1fr] lg:items-start">
      <div class="article-main">
        <SupersededNotice
          supersededBy={superseded_by}
          supersededByUrl={superseded_by_url}
          updates={updates}
        />
        <header class="article-header">
          <div class="flex flex-wrap items-center gap-3 text-sm">
            <span class="inline-flex items-center rounded-full border border-border px-3 py-1 text-[0.6rem] font-semibold uppercase tracking-[0.3em]">
              {categoryLabel}
            </span>
            <ArticleBadges article={article} />
          </div>
          <h1 class="font-heading text-5xl leading-[1.05] md:text-6xl">{title}</h1>
          <p class="text-lg text-muted">
            {renderKw(excerpt).map((node) =>
              node.type === "mark" ? <mark class="kw-mark">{node.value}</mark> : node.value
            )}
          </p>
          <BylineRow author={author} date={displayDate} readTime={readTime} />
        </header>

        <div class="article-hero">
          <figure class="border border-border bg-white">
            <img
              src={heroImage.src}
              alt={heroImage.alt}
              class="aspect-video h-full w-full object-cover"
              width="1600"
              height="900"
              loading="lazy"
            />
            {(heroImage.caption || heroImage.sourceUrl) && (
              <figcaption class="px-4 py-3 text-xs text-muted">
                {heroImage.caption}
                {heroImage.sourceUrl && (
                  <a href={heroImage.sourceUrl} class="text-fg underline ml-1">
                    Fonte: {new URL(heroImage.sourceUrl).hostname}
                  </a>
                )}
              </figcaption>
            )}
          </figure>
        </div>

        <ArticleTOC headings={headings} />

        <div class="prose article-prose">
          <slot />
        </div>

        <WhyItMattersCompact takeaways={takeaways} impact={impact} doNow={do_now} mode="article" />
        <RookieLens text={rookie_lens} />

        {(sources?.length || methodology_note) && (
          <details class="border border-border bg-white p-5">
            <summary class="flex cursor-pointer items-center justify-between text-[0.7rem] font-semibold uppercase tracking-[0.3em] text-muted">
              Fonti & Metodologia
              <span aria-hidden="true">+</span>
            </summary>
            <div class="mt-4 space-y-3 text-sm text-muted">
              <ul class="space-y-3 text-sm">
                {sources?.map((source) => (
                  <li key={source.url}>
                    <a href={source.url} class="underline" target="_blank" rel="noopener noreferrer">
                      {source.title}
                    </a>
                    <span class="text-muted">
                      · {source.publisher ?? new URL(source.url).hostname}{source.date ? ` · ${source.date}` : ""}
                    </span>
                  </li>
                ))}
              </ul>
              {methodology_note && <p class="text-xs text-muted">{methodology_note}</p>}
            </div>
          </details>
        )}

        <div class="flex flex-col gap-4 text-xs uppercase tracking-[0.35em] text-muted md:flex-row md:items-center md:justify-between">
          {prev ? (
            <a href={`/article/${prev.slug}`} class="hover:text-accent">← {prev.data.title}</a>
          ) : (
            <span />
          )}
          {next ? (
            <a href={`/article/${next.slug}`} class="hover:text-accent">{next.data.title} →</a>
          ) : (
            <span />
          )}
        </div>
      </div>
      <aside class="hidden lg:flex flex-col gap-6">
        <ArticleTOC headings={headings} />
      </aside>
    </div>
  </article>
  <RelatedArticles articles={related} getCategoryLabel={getCategoryLabel} />
  <script>
    const progressBar = document.getElementById("reading-progress");
    const updateProgress = () => {
      const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
      const progress = scrollHeight > clientHeight ? scrollTop / (scrollHeight - clientHeight) : 0;
      if (progressBar) {
        progressBar.style.transform = `scaleX(${progress})`;
      }
    };
    updateProgress();
    document.addEventListener("scroll", updateProgress, { passive: true });
  </script>
</BaseLayout>
