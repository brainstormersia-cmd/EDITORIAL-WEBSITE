---
import BaseLayout from "./BaseLayout.astro";
import BylineRow from "@theme/components/BylineRow.astro";
import ArticleCard from "@theme/components/ArticleCard.astro";
import CollapsibleSection from "@theme/components/CollapsibleSection.astro";
import WhyItMattersCompact from "@theme/components/WhyItMattersCompact.astro";
import RookieLens from "@theme/components/RookieLens.astro";
import KickerBar from "@theme/components/KickerBar.astro";
import HeroMedia from "@theme/components/HeroMedia.astro";
import TOCBox from "@theme/components/TOCBox.astro";
import { renderKw } from "@theme/utils/renderKw";
import { readingTime } from "@theme/utils/readingTime";
import { SITE_CONFIG } from "../site.config";

const { article, headings = [], related = [], prev, next } = Astro.props;
const {
  title,
  excerpt,
  category,
  author_id,
  published_at,
  updated_at,
  hero_image,
  hero_alt,
  hero_caption,
  hero_source,
  takeaways,
  impact,
  do_now,
  rookie_lens,
  sources,
  methodology_note
} = article.data;

const author = SITE_CONFIG.authors[author_id];
const categoryLabel = SITE_CONFIG.categories.find((item) => item.slug === category)?.label ?? category;
const heroImage = hero_image
  ? {
      src: hero_image,
      alt: hero_alt ?? title,
      caption: hero_caption ?? "",
      sourceUrl: hero_source
    }
  : null;
const readTime = readingTime(article.body ?? "");
const displayDate = published_at ?? updated_at ?? new Date().toISOString();
const canonicalUrl = `${SITE_CONFIG.siteUrl}/article/${article.slug}`;
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "NewsArticle",
  headline: title,
  datePublished: displayDate,
  dateModified: updated_at ?? displayDate,
  author: {
    "@type": "Organization",
    name: author?.name ?? SITE_CONFIG.name
  },
  image: heroImage?.src ? `${SITE_CONFIG.siteUrl}${heroImage.src}` : undefined,
  description: excerpt,
  mainEntityOfPage: canonicalUrl
};
---
<BaseLayout title={title} description={excerpt} image={heroImage?.src} canonical={canonicalUrl} type="article">
  <div class="reading-progress" id="reading-progress"></div>
  <article class="container section-block">
    <div class="grid gap-12">
      <div class="article-main">
        <header class="article-header">
          <KickerBar label={categoryLabel} />
          <h1 class="article-title font-heading text-4xl md:text-5xl font-black leading-[1.1] tracking-[-0.02em]">
            {title}
          </h1>
          <p class="dek text-lg text-muted" set:html={renderKw(excerpt)} />
          <BylineRow author={author} date={displayDate} readTime={readTime} />
        </header>

        <div class="article-hero">
          <HeroMedia heroImage={heroImage} title={title} dek={excerpt} />
        </div>

        <WhyItMattersCompact takeaways={takeaways} impact={impact} doNow={do_now} mode="article" />
        <RookieLens text={rookie_lens} />

        <CollapsibleSection title="In questo articolo" variant="subtle">
          <TOCBox headings={headings} mode="mobile" />
        </CollapsibleSection>

        <div class="prose article-prose">
          <slot />
        </div>

        <CollapsibleSection title="Fonti & Metodologia" variant="subtle">
          <ul class="space-y-3 text-sm">
            {sources?.map((source) => (
              <li key={source.url}>
                <a href={source.url} class="underline" target="_blank" rel="noopener noreferrer">
                  {source.title}
                </a>
                <span class="text-muted">
                  · {source.publisher ?? new URL(source.url).hostname}{source.date ? ` · ${source.date}` : ""}
                </span>
              </li>
            ))}
          </ul>
          {methodology_note && <p class="mt-3 text-xs text-muted">{methodology_note}</p>}
        </CollapsibleSection>

        <section>
          <h2 class="font-heading text-2xl">Articoli correlati</h2>
          <div class="mt-6 grid gap-6 md:grid-cols-2">
            {related.map((item) => (
              <ArticleCard article={item} key={item.slug} />
            ))}
          </div>
        </section>

        <div class="flex flex-col gap-4 text-xs uppercase tracking-[0.35em] text-muted md:flex-row md:items-center md:justify-between">
          {prev ? (
            <a href={`/article/${prev.slug}`} class="hover:text-accent">← {prev.data.title}</a>
          ) : (
            <span />
          )}
          {next ? (
            <a href={`/article/${next.slug}`} class="hover:text-accent">{next.data.title} →</a>
          ) : (
            <span />
          )}
        </div>
      </div>
    </div>
  </article>
  <script type="application/ld+json" is:inline>{JSON.stringify(jsonLd)}</script>
  <script>
    const progressBar = document.getElementById("reading-progress");
    const updateProgress = () => {
      const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
      const progress = scrollHeight > clientHeight ? scrollTop / (scrollHeight - clientHeight) : 0;
      if (progressBar) {
        progressBar.style.transform = `scaleX(${progress})`;
      }
    };
    updateProgress();
    document.addEventListener("scroll", updateProgress, { passive: true });
  </script>
</BaseLayout>
