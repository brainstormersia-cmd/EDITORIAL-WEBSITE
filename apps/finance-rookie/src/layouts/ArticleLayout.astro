---
import BaseLayout from "./BaseLayout.astro";
import BylineRow from "@theme/components/BylineRow.astro";
import ArticleCard from "@theme/components/ArticleCard.astro";
import CollapsibleSection from "@theme/components/CollapsibleSection.astro";
import WhyItMattersCompact from "@theme/components/WhyItMattersCompact.astro";
import RookieLens from "@theme/components/RookieLens.astro";
import KickerBar from "@theme/components/KickerBar.astro";
import HeroMedia from "@theme/components/HeroMedia.astro";
import TOCBox from "@theme/components/TOCBox.astro";
import { renderKw } from "@theme/utils/renderKw";
import { readingTime } from "@theme/utils/readingTime";
import { SITE_CONFIG } from "../site.config";

const { article, headings = [], related = [], prev, next } = Astro.props;
const {
  title,
  excerpt,
  category,
  author_id,
  published_at,
  updated_at,
  hero_image,
  hero_alt,
  hero_caption,
  hero_source,
  takeaways,
  impact,
  do_now,
  rookie_lens,
  sources,
  methodology_note,
  superseded_by,
  updates
} = article.data;

const author = SITE_CONFIG.authors[author_id];
const categoryLabel = SITE_CONFIG.categories.find((item) => item.slug === category)?.label ?? category;
const heroImage = hero_image
  ? {
      src: hero_image,
      alt: hero_alt ?? title,
      caption: hero_caption ?? "",
      sourceUrl: hero_source
    }
  : null;
const readTime = readingTime(article.body ?? "");
const displayDate = published_at ?? updated_at ?? new Date().toISOString();
const canonicalUrl = `${SITE_CONFIG.siteUrl}/article/${article.slug}`;
const articleVariant = category === "notizie" ? "news" : category === "analisi" ? "analysis" : "longform";
const relatedWithType = related.map((item, index) => {
  const sameCategory = item.data.category === category;
  const tagOverlap = item.data.tags?.some((tag) => article.data.tags?.includes(tag));
  const isNewer = new Date(item.data.published_at ?? 0).valueOf() > new Date(displayDate).valueOf();
  let type = "correlato";
  if (tagOverlap) type = "stesso-tema";
  if (isNewer) type = "evoluzione";
  if (!sameCategory) type = "impatto";
  if (index === 0) type = "correlato";
  return { item, type };
});
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "NewsArticle",
  headline: title,
  image: heroImage?.src ? [new URL(heroImage.src, SITE_CONFIG.siteUrl).toString()] : undefined,
  datePublished: displayDate,
  dateModified: updated_at ?? displayDate,
  author: [
    {
      "@type": "Person",
      name: author?.name ?? "Redazione FinanceRookie",
      url: SITE_CONFIG.siteUrl
    }
  ],
  publisher: {
    "@type": "Organization",
    name: SITE_CONFIG.name,
    logo: {
      "@type": "ImageObject",
      url: new URL("/logo.svg", SITE_CONFIG.siteUrl).toString()
    }
  },
  description: excerpt,
  mainEntityOfPage: canonicalUrl
};
---
<BaseLayout title={title} description={excerpt} image={heroImage?.src} canonical={canonicalUrl} type="article">
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  </Fragment>
  <div class="reading-progress" id="reading-progress"></div>
  <article class={`container section-block article article--${articleVariant}`}>
    <div class="grid gap-12 lg:grid-cols-[2.2fr,1fr] lg:items-start">
      <div class="article-main">
        {superseded_by && (
          <div class="superseded-banner">
            <p class="text-sm font-semibold">Questo articolo è stato superato.</p>
            <p class="text-sm text-muted mt-1">
              Versione aggiornata:{" "}
              <a class="underline" href={`/article/${superseded_by}`}>Leggi qui</a>
            </p>
            {updates?.length ? (
              <ol class="mt-3 space-y-2 text-xs text-muted">
                {updates.map((update) => (
                  <li>
                    <span class="font-semibold text-fg">{update.date ?? "Aggiornamento"}</span>
                    {" · "}
                    {update.slug ? <a class="underline" href={`/article/${update.slug}`}>{update.title}</a> : update.title}
                  </li>
                ))}
              </ol>
            ) : null}
          </div>
        )}
        <header class="article-header">
          <KickerBar label={categoryLabel} />
          <h1 class="article-title font-heading text-4xl md:text-5xl font-black leading-[1.1] tracking-[-0.02em]">
            {title}
          </h1>
          <p class="dek text-lg text-muted" set:html={renderKw(excerpt)} />
          <BylineRow author={author} date={displayDate} readTime={readTime} />
        </header>

        <div class="article-hero">
          <HeroMedia heroImage={heroImage} title={title} dek={excerpt} />
        </div>

        <div class="prose article-prose">
          <slot />
        </div>

        <WhyItMattersCompact takeaways={takeaways} impact={impact} doNow={do_now} mode="article" />
        <RookieLens text={rookie_lens} />

        <CollapsibleSection title="In questo articolo" variant="subtle">
          <TOCBox headings={headings} mode="mobile" />
        </CollapsibleSection>

        <CollapsibleSection title="Fonti & Metodologia" variant="subtle">
          <ul class="space-y-3 text-sm">
            {sources?.map((source) => (
              <li key={source.url}>
                <a href={source.url} class="underline" target="_blank" rel="noopener noreferrer">
                  {source.title}
                </a>
                <span class="text-muted">
                  · {source.publisher ?? new URL(source.url).hostname}{source.date ? ` · ${source.date}` : ""}
                </span>
              </li>
            ))}
          </ul>
          {methodology_note && <p class="mt-3 text-xs text-muted">{methodology_note}</p>}
        </CollapsibleSection>

        <div class="flex flex-col gap-4 text-xs uppercase tracking-[0.35em] text-muted md:flex-row md:items-center md:justify-between">
          {prev ? (
            <a href={`/article/${prev.slug}`} class="hover:text-accent">← {prev.data.title}</a>
          ) : (
            <span />
          )}
          {next ? (
            <a href={`/article/${next.slug}`} class="hover:text-accent">{next.data.title} →</a>
          ) : (
            <span />
          )}
        </div>
      </div>
      <aside class="hidden lg:flex flex-col gap-6 sticky top-28">
        <div class="related-panel">
          <h2 class="font-heading text-xl">Articoli correlati</h2>
          <ul class="mt-4 space-y-4">
            {relatedWithType.map(({ item, type }) => (
              <li>
                <p class="text-xs uppercase tracking-[0.35em] text-muted">{type}</p>
                <a href={`/article/${item.slug}`} class="block font-semibold hover:underline">
                  {item.data.title}
                </a>
              </li>
            ))}
          </ul>
        </div>
      </aside>
    </div>
  </article>
  <script>
    const progressBar = document.getElementById("reading-progress");
    const updateProgress = () => {
      const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
      const progress = scrollHeight > clientHeight ? scrollTop / (scrollHeight - clientHeight) : 0;
      if (progressBar) {
        progressBar.style.transform = `scaleX(${progress})`;
      }
    };
    updateProgress();
    document.addEventListener("scroll", updateProgress, { passive: true });
  </script>
</BaseLayout>
