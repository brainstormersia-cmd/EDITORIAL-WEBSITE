---
import { getCollection } from "astro:content";
import ArticleLayout from "../../layouts/ArticleLayout.astro";

export async function getStaticPaths() {
  const articles = (await getCollection("articles"))
    .filter((article) => article.data.status === "published")
    .filter((article) => !article.data.published_at || new Date(article.data.published_at) <= new Date());
  return articles.map((article) => ({
    params: { slug: article.slug },
    props: { article }
  }));
}

const { article } = Astro.props;
const { Content, headings } = await article.render();
const allArticles = (await getCollection("articles"))
  .filter((item) => item.data.status === "published")
  .filter((article) => !article.data.published_at || new Date(article.data.published_at) <= new Date());
const sorted = [...allArticles].sort(
  (a, b) => new Date(b.data.published_at ?? 0).valueOf() - new Date(a.data.published_at ?? 0).valueOf()
);
const index = sorted.findIndex((item) => item.slug === article.slug);
const prev = sorted[index + 1];
const next = sorted[index - 1];
const related = sorted
  .filter((item) => item.slug !== article.slug)
  .filter((item) => {
    const sameCategory = item.data.category === article.data.category;
    const tagOverlap = item.data.tags?.some((tag) => article.data.tags?.includes(tag));
    return sameCategory || tagOverlap;
  })
  .slice(0, 4);
---
<ArticleLayout article={article} headings={headings} related={related} prev={prev} next={next}>
  <Content />
</ArticleLayout>
