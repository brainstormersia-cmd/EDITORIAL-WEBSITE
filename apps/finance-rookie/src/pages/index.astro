---
import BaseLayout from "../layouts/BaseLayout.astro";
import HeroFeature from "../components/HeroFeature.astro";
import TrendingNow from "../components/TrendingNow.astro";
import { getCollection } from "astro:content";
import { SITE_CONFIG } from "../site.config";
import { readingTime } from "@theme/utils/readingTime";

const articles = (await getCollection("articles"))
  .filter((article) => article.data.status === "published")
  .filter((article) => !article.data.published_at || new Date(article.data.published_at) <= new Date())
  .sort((a, b) => new Date(b.data.published_at ?? 0).valueOf() - new Date(a.data.published_at ?? 0).valueOf());
const featuredItems = articles.filter((article) => article.data.featured);
const featured = featuredItems[0] ?? articles[0];
const breakingArticle = articles.find((article) => {
  if (article.data.breaking_until && article.data.breaking_until > new Date()) {
    return true;
  }
  return Boolean(article.data.breaking);
});
const trending = articles.slice(0, 3);
const getCategoryLabel = (slug) =>
  SITE_CONFIG.categories.find((item) => item.slug === slug)?.label ?? slug;
---
<BaseLayout
  title={SITE_CONFIG.name}
  description={SITE_CONFIG.description}
  breakingText={breakingArticle ? breakingArticle.data.title : "Nessuna breaking news al momento"}
  breakingHref={breakingArticle ? `/article/${breakingArticle.slug}` : undefined}
>
  <section class="section-block">
    <div class="container space-y-10">
      {featured && (
        <HeroFeature
          article={featured}
          author={SITE_CONFIG.authors[featured.data.author_id]}
          readTime={readingTime(featured.body ?? "")}
          categoryLabel={getCategoryLabel(featured.data.category)}
        />
      )}
    </div>
  </section>

  <TrendingNow items={trending} getCategoryLabel={getCategoryLabel} />

</BaseLayout>
