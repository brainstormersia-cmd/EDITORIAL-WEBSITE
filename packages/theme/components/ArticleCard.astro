---
import KickerBar from "./KickerBar.astro";
import BreakingBadge from "./BreakingBadge.astro";
import { renderKw } from "../utils/renderKw";

const { article, variant = "default", categoryLabel, readTime } = Astro.props;
const {
  title,
  excerpt,
  category,
  hero_image,
  hero_alt,
  hero_caption,
  hero_source,
  published_at,
  updated_at
} = article.data;
const heroImage = hero_image
  ? {
      src: hero_image,
      alt: hero_alt ?? title,
      caption: hero_caption ?? "",
      sourceUrl: hero_source
    }
  : null;
const label = categoryLabel ?? category;
const displayDate = published_at ?? updated_at ?? new Date().toISOString();
const formattedDate = new Intl.DateTimeFormat("it-IT", {
  day: "2-digit",
  month: "short",
  year: "numeric"
}).format(new Date(displayDate));
const displayReadTime =
  typeof readTime === "string" ? readTime : readTime ? `${readTime} min lettura` : "—";
const isRecent = published_at
  ? Date.now() - new Date(published_at).getTime() < 60 * 60 * 1000
  : false;
const showBreaking = Boolean(article.data.breaking);
const showLive = Boolean(article.data.live);
---
<article class="card-hover border border-border bg-white">
  <a href={`/article/${article.slug}`} class="block">
    <div class="relative">
      {heroImage && (
        <img
          src={heroImage.src}
          alt={heroImage.alt}
          class="h-48 w-full object-cover"
          width="800"
          height="450"
          loading="lazy"
        />
      )}
      {(showBreaking || showLive || isRecent) && (
        <div class="absolute left-3 top-3 flex flex-wrap gap-2">
          {showBreaking && <BreakingBadge label="Breaking" variant="breaking" />}
          {showLive && <BreakingBadge label="Live" variant="live" />}
          {!showBreaking && !showLive && isRecent && (
            <BreakingBadge label="Appena pubblicato" variant="recent" />
          )}
        </div>
      )}
    </div>
    <div class="p-5 space-y-3">
      {variant === "featured" ? (
        <KickerBar label={label} variant="compact" />
      ) : (
        <span class="text-xs uppercase tracking-[0.35em] text-muted">{label}</span>
      )}
      <h3 class="font-heading text-2xl font-bold leading-tight">{title}</h3>
      <p class="dek text-sm text-muted" set:html={renderKw(excerpt)} />
      <div class="text-[0.7rem] uppercase tracking-[0.35em] text-muted">
        {formattedDate} · {displayReadTime}
      </div>
    </div>
  </a>
</article>
