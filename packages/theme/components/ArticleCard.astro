---
import ArticleMeta from "./ArticleMeta.astro";
import { getArticleBadge } from "../../../apps/finance-rookie/src/lib/badges";
import { renderKw } from "../../../apps/finance-rookie/src/lib/kw";
import { SITE_CONFIG } from "../../../apps/finance-rookie/src/site.config";

const { article, variant = "default", categoryLabel, readTime } = Astro.props;
const {
  title,
  excerpt,
  category,
  hero_image,
  hero_alt,
  hero_caption,
  hero_source,
  published_at,
  updated_at,
  updatedAt
} = article.data;
const heroImage = {
  src: hero_image ?? "/images/hero-finanza.svg",
  alt: hero_alt ?? title ?? `Immagine su ${category}`,
  caption: hero_caption ?? "",
  sourceUrl: hero_source
};
const label = categoryLabel ?? category;
const displayDate = published_at ?? updatedAt ?? updated_at ?? new Date().toISOString();
const displayReadTime = typeof readTime === "string" ? readTime : readTime ? `${readTime} min lettura` : null;
const badge = getArticleBadge(article);
const author = SITE_CONFIG.authors[article.data.author_id];
---
<article class="card-hover border border-border bg-white">
  <a
    href={`/article/${article.slug}`}
    class="group block focus-visible:outline focus-visible:outline-2 focus-visible:outline-accent focus-visible:outline-offset-2"
    aria-label={`Leggi ${title}`}
  >
    <div class="relative">
      <img
        src={heroImage.src}
        alt={heroImage.alt}
        class="h-48 w-full object-cover"
        width="800"
        height="450"
        loading="lazy"
      />
      {badge && (
        <div class="absolute left-3 top-3 flex flex-wrap gap-2">
          <span class={`badge badge--${badge.variant}`}>
            {badge.variant === "breaking" || badge.variant === "live" ? <span class="badge-dot" /> : null}
            {badge.label}
          </span>
        </div>
      )}
    </div>
    <div class="p-5 space-y-3">
      <span class="text-xs uppercase tracking-[0.35em] text-muted">{label}</span>
      <h3 class="font-heading text-2xl font-bold leading-tight group-hover:underline">{title}</h3>
      <p class="dek text-sm text-muted">
        {renderKw(excerpt).map((node) =>
          node.type === "mark" ? <mark class="kw-mark">{node.value}</mark> : node.value
        )}
      </p>
      <ArticleMeta author={author} date={displayDate} readTime={displayReadTime} size="compact" />
    </div>
  </a>
</article>
