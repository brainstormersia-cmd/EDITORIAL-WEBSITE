---
import { getCollection } from "astro:content";
import ArticleLayout from "../../layouts/ArticleLayout.astro";

export async function getStaticPaths() {
  const articles = (await getCollection("articles")).filter((article) => !article.data.draft);
  return articles.map((article) => ({
    params: { slug: article.slug },
    props: { article }
  }));
}

const { article } = Astro.props;
const { Content, headings } = await article.render();
const allArticles = (await getCollection("articles")).filter((item) => !item.data.draft);
const sorted = [...allArticles].sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
const index = sorted.findIndex((item) => item.slug === article.slug);
const prev = sorted[index + 1];
const next = sorted[index - 1];
const related = sorted
  .filter((item) => item.slug !== article.slug && item.data.category.slug === article.data.category.slug)
  .slice(0, 3);
---
<ArticleLayout article={article} headings={headings} related={related} prev={prev} next={next}>
  <Content />
</ArticleLayout>
