---
import BaseLayout from "../layouts/BaseLayout.astro";
import FeaturedPost from "../components/FeaturedPost.astro";
import TrendingList from "../components/TrendingList.astro";
import PostCard from "../components/PostCard.astro";
import NewsletterBox from "../components/NewsletterBox.astro";
import SectionHeader from "../components/SectionHeader.astro";
import { getCollection } from "astro:content";
import { getImageByName } from "../utils/imageMap";
import { slugify } from "../utils/slug";
import { SITE_CONFIG } from "../consts";

const posts = (await getCollection("blog")).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);
const featured = posts[0];
const trending = posts.slice(0, 5);
const latest = posts.slice(0, 4);
const analysisPosts = posts.filter((post) => post.data.category.toLowerCase() === "analisi");
const analysisMain = analysisPosts[0];
const analysisSecondary = analysisPosts.slice(1, 4);
const categories = ["Finanza", "Economia", "Notizie"];
const editorsPicks = posts.slice(1, 4);
---
<BaseLayout title={SITE_CONFIG.name} description={SITE_CONFIG.description}>
  <div class="container py-10 space-y-12">
    <FeaturedPost post={featured} image={getImageByName(featured.data.mainImage)} />

    <section class="grid gap-8 lg:grid-cols-[2fr,1fr]">
      <div>
        <SectionHeader title="Trending" linkText="Archivio" linkHref="/blog" />
        <div class="mt-6">
          <TrendingList posts={trending} />
        </div>
      </div>
      <aside class="space-y-6">
        <NewsletterBox />
        <div class="border border-border p-6">
          <h3 class="text-sm uppercase tracking-[0.3em]">Editorâ€™s picks</h3>
          <ul class="mt-4 space-y-3 text-sm">
            {editorsPicks.map((post) => (
              <li>
                <a href={`/blog/${post.slug}`} class="hover:text-accent">{post.data.title}</a>
              </li>
            ))}
          </ul>
        </div>
      </aside>
    </section>

    <section>
      <SectionHeader title="Latest" linkText="Vedi tutto" linkHref="/blog" />
      <div class="mt-6 grid gap-6 md:grid-cols-2">
        {latest.map((post) => (
          <PostCard post={post} image={getImageByName(post.data.mainImage)} />
        ))}
      </div>
    </section>

    <section>
      <SectionHeader title="Analisi" linkText="Vedi analisi" linkHref="/category/analisi" />
      <div class="mt-6 grid gap-6 lg:grid-cols-[2fr,1fr]">
        {analysisMain && (
          <PostCard post={analysisMain} image={getImageByName(analysisMain.data.mainImage)} />
        )}
        <div class="space-y-4">
          {analysisSecondary.map((post) => (
            <PostCard post={post} image={getImageByName(post.data.mainImage)} variant="compact" />
          ))}
        </div>
      </div>
    </section>

    <section class="grid gap-8 lg:grid-cols-3">
      {categories.map((category) => {
        const items = posts.filter((post) => post.data.category === category).slice(0, 4);
        return (
          <div class="border border-border p-6" key={category}>
            <h3 class="text-lg font-bold">{category}</h3>
            <ul class="mt-4 space-y-3 text-sm">
              {items.map((post) => (
                <li>
                  <a href={`/blog/${post.slug}`} class="hover:text-accent">{post.data.title}</a>
                </li>
              ))}
            </ul>
            <a
              href={`/category/${slugify(category)}`}
              class="mt-4 inline-block text-xs uppercase tracking-[0.3em] hover:text-accent"
            >
              Vedi tutti
            </a>
          </div>
        );
      })}
    </section>
  </div>
</BaseLayout>
